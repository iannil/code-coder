# CodeCoder Architecture Overview

## System Overview (ASCII)

```
┌────────────────────────────────────────────────────────────────────────────┐
│                           CodeCoder Architecture                            │
├────────────────────────────────────────────────────────────────────────────┤
│                                                                              │
│  ┌──────────────────────────────────────────────────────────────────────┐   │
│  │                        🖥️  INTERFACE LAYER                           │   │
│  │   ┌─────────────┐   ┌──────────────────┐   ┌──────────────────┐     │   │
│  │   │ CLI Commands │   │ TUI (Solid.js)   │   │ HTTP API (Hono)  │     │   │
│  │   └──────┬──────┘   └────────┬─────────┘   └─────────┬────────┘     │   │
│  └──────────│───────────────────│───────────────────────│──────────────┘   │
│             │                   │                       │                   │
│             └───────────────────┼───────────────────────┘                   │
│                                 ▼                                           │
│  ┌──────────────────────────────────────────────────────────────────────┐   │
│  │                         ⚙️  CORE ENGINE                               │   │
│  │   ┌─────────────┐   ┌──────────────────┐   ┌──────────────────┐     │   │
│  │   │   Session   │──▶│  Agent System    │──▶│ LLM Orchestration│     │   │
│  │   │   Manager   │   │  (23+ Agents)    │   │                  │     │   │
│  │   └─────────────┘   └──────────────────┘   └────────┬─────────┘     │   │
│  │                              │                       │               │   │
│  │                              ▼                       │               │   │
│  │   ┌──────────────────────────────────────┐          │               │   │
│  │   │     Tool Registry (25+ Tools)         │◀─────────┘               │   │
│  │   │  read | write | bash | glob | grep    │                          │   │
│  │   │  task | webfetch | websearch | mcp    │                          │   │
│  │   └──────────────────────────────────────┘                          │   │
│  └──────────────────────────────────────────────────────────────────────┘   │
│                                 │                                           │
│                                 ▼                                           │
│  ┌──────────────────────────────────────────────────────────────────────┐   │
│  │                       🤖  AI PROVIDERS (20+)                          │   │
│  │   ┌──────────┐ ┌──────────┐ ┌──────────┐ ┌──────────────────────┐   │   │
│  │   │ Anthropic│ │  OpenAI  │ │  Google  │ │ Azure, Bedrock, etc. │   │   │
│  │   │ (Claude) │ │  (GPT)   │ │ (Gemini) │ │ Copilot, OpenRouter  │   │   │
│  │   └──────────┘ └──────────┘ └──────────┘ └──────────────────────┘   │   │
│  └──────────────────────────────────────────────────────────────────────┘   │
│                                 │                                           │
│           ┌─────────────────────┼─────────────────────┐                     │
│           ▼                     ▼                     ▼                     │
│  ┌─────────────────┐ ┌───────────────────┐ ┌─────────────────────────────┐ │
│  │  🔌 Extensions   │ │ 💾 Storage Layer  │ │    🚀 Autonomous Mode        │ │
│  │ ┌─────────────┐ │ │ ┌───────────────┐ │ │ ┌───────────────────────┐   │ │
│  │ │MCP Protocol │ │ │ │ JSON + Backup │ │ │ │ State Machine         │   │ │
│  │ └─────────────┘ │ │ └───────────────┘ │ │ │ CLOSE Decision Engine │   │ │
│  │ ┌─────────────┐ │ │ ┌───────────────┐ │ │ │ Safety Guards         │   │ │
│  │ │Memory System│ │ │ │ Health Check  │ │ │ │ TDD Execution         │   │ │
│  │ └─────────────┘ │ │ └───────────────┘ │ │ └───────────────────────┘   │ │
│  └─────────────────┘ └───────────────────┘ └─────────────────────────────┘ │
│                                                                              │
└──────────────────────────────────────────────────────────────────────────────┘
```

## Agent System

```
┌─────────────────────────────────────────────────────────────────────────┐
│                          Agent Registry                                   │
├─────────────────┬──────────────────┬───────────────────┬────────────────┤
│   PRIMARY       │   ENGINEERING    │     CONTENT       │   祝融说 (ZRS)   │
├─────────────────┼──────────────────┼───────────────────┼────────────────┤
│ build 🔨        │ code-reviewer 👀 │ writer ✍️         │ observer 👁️    │
│ plan 📋         │ security 🔒      │ expander 📖       │ decision ⚖️    │
│ writer ✍️       │ tdd-guide 🧪     │ proofreader 📝    │ macro 📊       │
│ autonomous 🤖   │ architect 🏗️     │                   │ trader 💹      │
│                 │ verifier ✅      │                   │ picker 🎯      │
│                 │                  │                   │ miniproduct 🚀 │
│                 │                  │                   │ ai-engineer 🤖 │
├─────────────────┴──────────────────┴───────────────────┴────────────────┤
│   UTILITY: explore 🔍 | general 🔧 | code-reverse ⚙️ | jar-reverse 📦    │
└─────────────────────────────────────────────────────────────────────────┘
```

## Autonomous Mode State Machine

```
                              ┌─────────────┐
                              │    IDLE     │
                              └──────┬──────┘
                                     │ start()
                                     ▼
┌──────────────────────────────────────────────────────────────────────────┐
│                           PLANNING PHASE                                  │
│  ┌────────────┐    ┌─────────────────┐    ┌───────────────┐             │
│  │ PLANNING   │───▶│ UNDERSTANDING   │───▶│ PLAN_APPROVED │             │
│  └────────────┘    └─────────────────┘    └───────┬───────┘             │
└───────────────────────────────────────────────────│──────────────────────┘
                                                    │ CLOSE evaluate
                                                    ▼
┌──────────────────────────────────────────────────────────────────────────┐
│                           DECISION PHASE                                  │
│  ┌────────────┐    ┌─────────────────┐         ┌──────────┐             │
│  │  DECIDING  │───▶│  DECISION_MADE  │─────────│  BLOCKED │──▶ PAUSED   │
│  └────────────┘    └────────┬────────┘         └──────────┘             │
└─────────────────────────────│────────────────────────────────────────────┘
                              │ TDD Cycle
                              ▼
┌──────────────────────────────────────────────────────────────────────────┐
│                          EXECUTION PHASE                                  │
│  ┌────────────┐    ┌─────────────┐    ┌────────────┐    ┌────────────┐  │
│  │ EXECUTING  │───▶│  TESTING    │───▶│ VERIFYING  │───▶│ EVALUATING │  │
│  └────────────┘    └──────┬──────┘    └────────────┘    └─────┬──────┘  │
│                           │ fail                              │          │
│                           ▼                                   │          │
│                    ┌────────────┐                             │          │
│                    │  FIXING    │◀────────────────────────────┘          │
│                    └────────────┘                                        │
└──────────────────────────────────────────────────────────────────────────┘
                                          │
            ┌─────────────────────────────┼──────────────────────────────┐
            │                             │                              │
            ▼                             ▼                              ▼
   ┌─────────────────┐          ┌─────────────────┐          ┌─────────────────┐
   │   CONTINUING    │          │    COMPLETED    │          │      FAILED     │
   │ (next iteration)│          │   (success)     │          │    (error)      │
   └────────┬────────┘          └─────────────────┘          └─────────────────┘
            │
            └───────────────────────────────▶ PLANNING
```

## Data Flow

```
┌─────────────────────────────────────────────────────────────────────────┐
│                            INPUT SOURCES                                 │
│   User Input  ──┐                                                        │
│   File Attach ──┼──▶ ┌──────────────────────────────────────────────┐   │
│   MCP Tools   ──┘    │              SESSION                          │   │
│                      │  ┌────────────┐  ┌────────────┐              │   │
│                      │  │ Messages   │  │ Agent Info │              │   │
│                      │  │ (V2)       │  │ Model Info │              │   │
│                      │  └────────────┘  └────────────┘              │   │
│                      └──────────────────────────────────────────────┘   │
└─────────────────────────────────────────────────────────────────────────┘
                                    │
     ┌──────────────────────────────┼──────────────────────────────┐
     ▼                              ▼                              ▼
┌─────────────┐             ┌──────────────┐              ┌─────────────┐
│   CONFIG    │             │   STORAGE    │              │   MEMORY    │
├─────────────┤             ├──────────────┤              ├─────────────┤
│ Global      │             │ JSON Store   │              │ Daily .md   │
│ Project     │             │ Auto Backup  │              │ MEMORY.md   │
│ Env Vars    │             │ Health Check │              │ (Sediment)  │
│ Rules/*.md  │             │ Recovery     │              │             │
└─────────────┘             └──────────────┘              └─────────────┘
                                    │
                                    ▼
┌─────────────────────────────────────────────────────────────────────────┐
│                            OUTPUT                                        │
│   TUI Display  │  File Changes  │  API Response  │  SSE Stream          │
└─────────────────────────────────────────────────────────────────────────┘
```

## Provider Integration

```
                         ┌───────────────────┐
                         │   Vercel AI SDK   │
                         │ (streamText, tool)│
                         └─────────┬─────────┘
                                   │
              ┌────────────────────┼────────────────────┐
              │                    │                    │
              ▼                    ▼                    ▼
    ┌─────────────────┐  ┌─────────────────┐  ┌─────────────────┐
    │ Provider Options│  │ Message Xform   │  │ Model Params    │
    │ (timeout, etc.) │  │ (Claude, GPT)   │  │ (temp, topP)    │
    └────────┬────────┘  └────────┬────────┘  └────────┬────────┘
             │                    │                    │
             └────────────────────┼────────────────────┘
                                  │
       ┌──────────────────────────┼──────────────────────────┐
       │                          │                          │
       ▼                          ▼                          ▼
┌────────────────┐    ┌──────────────────┐    ┌─────────────────────────┐
│   TIER 1       │    │     TIER 2       │    │        TIER 3           │
│ Full Support   │    │   Enterprise     │    │     Specialized         │
├────────────────┤    ├──────────────────┤    ├─────────────────────────┤
│ Anthropic      │    │ Azure            │    │ OpenRouter              │
│ (Claude 3/4)   │    │ Amazon Bedrock   │    │ xAI (Grok)              │
│ OpenAI (GPT)   │    │ Google Vertex    │    │ Mistral                 │
│ Google (Gemini)│    │ GitHub Copilot   │    │ Groq                    │
├────────────────┴────┴──────────────────┴────┴─────────────────────────┤
│                           TIER 4: Additional                           │
│ DeepInfra | Cerebras | Cohere | TogetherAI | Perplexity | Vercel      │
└────────────────────────────────────────────────────────────────────────┘
```

---

## Quick Reference

| Component | Location | Purpose |
|-----------|----------|---------|
| Entry Point | `src/index.ts` | CLI initialization |
| Agent Defs | `src/agent/agent.ts` | 23+ agent definitions |
| LLM Stream | `src/session/llm.ts` | Unified LLM calling |
| Providers | `src/provider/` | 20+ SDK integrations |
| Tools | `src/tool/` | 25+ built-in tools |
| MCP | `src/mcp/` | Protocol support |
| Autonomous | `src/autonomous/` | Self-driving mode |
| Storage | `src/storage/` | JSON + backup |
| API | `src/api/` | HTTP server (Hono) |
