%%{init: {'theme': 'base', 'themeVariables': { 'primaryColor': '#7aa2f7', 'lineColor': '#a9b1d6'}}}%%
flowchart TB
    subgraph Step1["1ï¸âƒ£ Input"]
        User["ðŸ‘¤ User"]
        Input["Input Message"]
        User --> Input
    end

    subgraph Step2["2ï¸âƒ£ Session"]
        CLI["CLI/TUI"]
        Session["Session"]
        MsgV2["MessageV2.User"]
        Input --> CLI
        CLI --> Session
        Session --> MsgV2
    end

    subgraph Step3["3ï¸âƒ£ System Prompt"]
        SysPrompt["SystemPrompt"]
        Header["header()"]
        Provider["provider()"]
        Custom["custom()"]
        Memory["markdownMemory()"]
        MsgV2 --> SysPrompt
        SysPrompt --> Header
        SysPrompt --> Provider
        SysPrompt --> Custom
        SysPrompt --> Memory
    end

    subgraph Step4["4ï¸âƒ£ LLM Stream"]
        LLM["LLM.stream()"]
        GetLang["Provider.getLanguage()"]
        Model["LanguageModel"]
        Custom --> LLM
        Memory --> LLM
        LLM --> GetLang
        GetLang --> Model
    end

    subgraph Step5["5ï¸âƒ£ AI Provider"]
        APIReq["AI API Request"]
        Streaming["Streaming Response"]
        Tokens["Token Chunks"]
        Model --> APIReq
        APIReq --> Streaming
        Streaming --> Tokens
    end

    subgraph Step6["6ï¸âƒ£ Tool Execution"]
        ToolCheck{Tool Call?}
        ToolExec["Execute Tool"]
        ToolResult["Tool Result"]
        Tokens --> ToolCheck
        ToolCheck -->|Yes| ToolExec
        ToolExec --> ToolResult
        ToolResult --> APIReq
    end

    subgraph Step7["7ï¸âƒ£ Response"]
        Final["Final Result"]
        Bus["Event Bus"]
        Display["Display Response"]
        ToolCheck -->|No| Final
        Final --> Bus
        Bus --> Display
    end

    Display --> User
