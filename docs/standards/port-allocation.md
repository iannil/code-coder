# 端口分配规范

> 文档类型: standard
> 创建时间: 2026-02-23
> 最后更新: 2026-02-23
> 状态: active

## 概述

本文档定义 CodeCoder 项目的端口分配规范，确保服务间无冲突并预留扩展空间。

## 端口范围

CodeCoder 使用 **4400-4449** 端口范围，按功能分组：

| 端口段 | 用途 | 预留数量 |
| -------- | ------ | ---------- |
| 4400-4409 | 核心服务 | 10 |
| 4410-4419 | 独立 Rust 服务 | 10 |
| 4420-4429 | 协议/工具服务 | 10 |
| 4430-4439 | 第三方集成 | 10 |
| 4440-4449 | 测试端口 | 10 |

## 当前端口分配

### 核心服务 (4400-4409)

| 端口 | 服务 | 技术栈 | 说明 |
| ------ | ------ | -------- | ------ |
| 4400 | CodeCoder API Server | Bun/TypeScript | 核心 AI 引擎 API |
| 4401 | Web Frontend | Vite/React | Web 管理界面 |
| 4402 | Zero CLI Daemon | Rust | 组合服务 (gateway + channels + scheduler) |
| 4403 | Faster Whisper STT | Docker | 本地语音转文字服务 |
| 4404-4409 | 预留 | - | 未来核心服务扩展 |

### 独立 Rust 服务 (4410-4419)

| 端口 | 服务 | 说明 |
| ------ | ------ | ------ |
| 4410 | Zero Gateway | 认证、路由、配额管理 |
| 4411 | Zero Channels | Telegram/Discord/Slack/飞书/企微 |
| 4412 | Zero Workflow | Webhook/Cron/Git 集成 |
| 4413-4419 | 预留 | 未来 Rust 服务扩展 |

### 协议/工具服务 (4420-4429)

| 端口 | 服务 | 说明 |
| ------ | ------ | ------ |
| 4420 | MCP Server (HTTP) | Model Context Protocol 服务 |
| 4421-4429 | 预留 | 未来协议服务扩展 |

### 第三方集成 (4430-4439)

| 端口 | 服务 | 说明 |
| ------ | ------ | ------ |
| 4430-4439 | 预留 | 外部服务集成 |

### 测试端口 (4440-4449)

| 端口 | 用途 | 说明 |
| ------ | ------ | ------ |
| 4440 | MCP 集成测试 | 测试环境使用 |
| 4441-4449 | 预留 | 其他测试用途 |

## 配置方式

### 配置文件 (~/.codecoder/config.json)

```json
{
  "gateway": {
    "port": 4410,
    "host": "127.0.0.1"
  },
  "channels": {
    "port": 4411,
    "host": "127.0.0.1"
  },
  "workflow": {
    "webhook": {
      "port": 4412,
      "host": "127.0.0.1"
    }
  }
}
```

### 环境变量

| 变量 | 描述 | 默认值 |
| ------ | ------ | -------- |
| `GATEWAY_PORT` | 网关服务端口 | 4410 |
| `CHANNELS_PORT` | 渠道服务端口 | 4411 |
| `WORKFLOW_PORT` | 工作流服务端口 | 4412 |

## 新增服务端口申请

新增服务时，按以下规则分配端口：

1. **确定分类**：根据服务类型选择对应端口段
2. **选择端口**：在该段内选择下一个可用端口
3. **更新文档**：更新本文档和相关配置
4. **通知团队**：确保团队成员知晓变更

## 端口冲突检查

```bash
# 检查端口占用
lsof -i :4400-4449

# 检查特定端口
lsof -i :4410

# 使用 ops.sh 检查服务状态
./ops.sh status
```

## 相关文档

- [部署指南](../guides/DEPLOYMENT.md)
- [运行手册](../RUNBOOK.md)
- [MCP 服务指南](./mcp-guide.md)
