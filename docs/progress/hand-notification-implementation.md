# Hand 执行结果 IM 推送功能实现

**日期**: 2026-02-28
**状态**: ✅ 已完成

## 概述

为 zero-workflow 服务的 Hand 执行器添加了 IM 推送功能。当 Hand 执行完成后，可以将结果主动推送到 IM 渠道（Telegram、飞书、企业微信等）。

## 实现内容

### 1. 配置类型 (`services/zero-common/src/config.rs`)

添加了 `HandNotificationConfig` 结构体：

```rust
pub struct HandNotificationConfig {
    pub channel_type: String,  // telegram, feishu, wecom, dingtalk, discord, slack
    pub channel_id: String,     // 群组/频道 ID
    pub template: String,       // brief (简洁), detailed (详细)
    pub send_when: String,      // always, on_success, on_failure
}
```

### 2. Hand 配置扩展 (`services/zero-workflow/src/hands/manifest.rs`)

在 `HandConfig` 中添加了可选的 `notification` 字段：

```rust
pub struct HandConfig {
    // ... 现有字段 ...
    pub notification: Option<HandNotificationConfig>,
    // ...
}
```

### 3. 通知桥接器 (`services/zero-workflow/src/hands/notification_bridge.rs`)

新建 `NotificationBridge` 模块，负责：

- 检查是否应该发送通知（根据 `send_when` 配置）
- 格式化通知消息（`brief` 和 `detailed` 两种模板）
- 调用 zero-channels 的 `POST /api/v1/send` API 发送消息

### 4. 执行器集成 (`services/zero-workflow/src/hands/executor.rs`)

在 `HandExecutor` 中：

- 添加了 `channels_endpoint` 字段
- 添加了 `with_channels_endpoint()` builder 方法
- 在 `execute()` 方法末尾，非阻塞发送通知（`tokio::spawn`）

## 配置示例

在 HAND.md 的 frontmatter 中添加 notification 配置：

```yaml
---
id: "market-sentinel"
name: "Market Sentinel"
schedule: "0 */30 * * * *"
agent: "macro"
enabled: true

# 通知配置
notification:
  channel_type: "telegram"
  channel_id: "-1001234567890"
  template: "brief"
  send_when: "on_success"

autonomy:
  level: "crazy"
  unattended: true
---
```

## 消息格式

### brief 模板（简洁）

```
✅ Hand 执行成功

**Market Sentinel** (market-sentinel)
Agent: macro | 耗时: 2.5s

[执行结果摘要...]

---
Generated at 2026-02-28 10:00:00 UTC
```

### detailed 模板（详细）

```markdown
# Hand 执行报告

## 基本信息
- **Hand**: Market Sentinel (market-sentinel)
- **Agent**: macro
- **状态**: ✅ Success
- **开始时间**: 2026-02-28 10:00:00 UTC
- **结束时间**: 2026-02-28 10:00:02 UTC
- **耗时**: 2.5s

## CLOSE 评估
- **总分**: 7.5/10
- Convergence: 7.2
- Leverage: 7.8
...

## 执行结果
[完整输出...]

---
*Generated by Hands system*
```

## 错误处理策略

1. **非阻塞发送**: 使用 `tokio::spawn` 异步发送，不阻塞主流程
2. **最佳努力**: 推送失败只记录警告日志，不影响 hand 执行状态
3. **超时控制**: HTTP 请求设置 10 秒超时

## 测试

新增 6 个单元测试，全部通过：

- `test_should_send_on_success`: 测试成功时发送逻辑
- `test_should_send_on_failure`: 测试失败时发送逻辑
- `test_should_send_always`: 测试始终发送逻辑
- `test_format_brief_message`: 测试简洁消息格式
- `test_format_detailed_message`: 测试详细消息格式
- `test_format_brief_with_error`: 测试带错误的简洁消息

## 文件变更

| 文件 | 变更类型 |
|------|---------|
| `services/zero-common/src/config.rs` | 新增 `HandNotificationConfig` |
| `services/zero-common/src/lib.rs` | 导出 `HandNotificationConfig` 和 `MonitorNotificationConfig` |
| `services/zero-workflow/src/hands/manifest.rs` | 添加 `notification` 字段到 `HandConfig` |
| `services/zero-workflow/src/hands/executor.rs` | 集成通知发送逻辑 |
| `services/zero-workflow/src/hands/notification_bridge.rs` | **新建** 通知桥接器模块 |
| `services/zero-workflow/src/hands/mod.rs` | 导出 `NotificationBridge` 和 `HandNotificationConfig` |

## 下一步

- [ ] 在 `~/.codecoder/hands/` 下创建测试 hand，配置 notification
- [ ] 运行 hand 执行
- [ ] 检查 IM 渠道是否收到消息
- [ ] 验证消息格式正确
- [ ] 测试各种 send_when 条件
