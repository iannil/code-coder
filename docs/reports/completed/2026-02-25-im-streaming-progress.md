# IM å®æ—¶è¿›åº¦åé¦ˆå®æ–½å®ŒæˆæŠ¥å‘Š

**æ—¥æœŸ**: 2026-02-25
**çŠ¶æ€**: å·²å®Œæˆï¼ˆå¾…é›†æˆæµ‹è¯•ï¼‰

## å®æ–½æ‘˜è¦

å®ç°äº† IM æ¸ é“çš„å®æ—¶è¿›åº¦åé¦ˆåŠŸèƒ½ï¼Œè®©ç”¨æˆ·åœ¨ Telegram ç­‰ IM ä¸­å¯ä»¥çœ‹åˆ°ä»»åŠ¡æ‰§è¡Œçš„å®æ—¶è¿›åº¦ã€‚

## å®Œæˆçš„å·¥ä½œ

### Phase 1: é…ç½®å¼€å…³ âœ…

**ä¿®æ”¹æ–‡ä»¶**: `services/zero-common/src/config.rs`

æ–°å¢é…ç½®é¡¹ï¼š
- `streaming_enabled: bool` - æ˜¯å¦å¯ç”¨æµå¼è¿›åº¦åé¦ˆï¼ˆé»˜è®¤ trueï¼‰
- `progress_throttle_ms: u64` - è¿›åº¦æ›´æ–°èŠ‚æµé—´éš”ï¼ˆé»˜è®¤ 1000msï¼‰

### Phase 2: SSE å®¢æˆ·ç«¯æ¨¡å— âœ…

**æ–°å»ºæ–‡ä»¶**: `services/zero-channels/src/sse.rs`

åŠŸèƒ½ï¼š
- `SseTaskClient` - è¿æ¥ CodeCoder ä»»åŠ¡äº‹ä»¶ SSE ç«¯ç‚¹
- `TaskEvent` - åŒ¹é… TypeScript å®šä¹‰çš„äº‹ä»¶ç±»å‹ï¼ˆthought, tool_use, progress, finish ç­‰ï¼‰
- è‡ªåŠ¨é‡è¿æœºåˆ¶ï¼ˆæŒ‡æ•°é€€é¿ï¼Œæœ€å¤š 3 æ¬¡é‡è¯•ï¼‰
- å¼‚æ­¥äº‹ä»¶æµé€šè¿‡ `mpsc::Receiver` ä¼ é€’

### Phase 3: è¿›åº¦å¤„ç†å™¨æ¨¡å— âœ…

**æ–°å»ºæ–‡ä»¶**: `services/zero-channels/src/progress.rs`

åŠŸèƒ½ï¼š
- `ImProgressHandler` - å®ç°æ··åˆæ¨¡å¼è¿›åº¦åé¦ˆ
- `ProgressHandler` trait - å¯æ‰©å±•çš„è¿›åº¦å¤„ç†æ¥å£
- å…³é”®èŠ‚ç‚¹ï¼ˆå¼€å§‹ã€å·¥å…·è°ƒç”¨ã€å®Œæˆï¼‰å‘æ–°æ¶ˆæ¯
- ä¸­é—´è¿›åº¦ç¼–è¾‘ç°æœ‰æ¶ˆæ¯ï¼ˆå¸¦èŠ‚æµï¼‰
- å·¥å…·åç§°æœ¬åœ°åŒ–ï¼ˆå¦‚ "Read" â†’ "ğŸ“„ è¯»å–æ–‡ä»¶"ï¼‰

### Phase 4: æ¡¥æ¥å™¨å¢å¼º âœ…

**ä¿®æ”¹æ–‡ä»¶**: `services/zero-channels/src/bridge.rs`

æ–°å¢ï¼š
- `with_telegram()` - è®¾ç½® Telegram æ¸ é“ç”¨äºæ¶ˆæ¯ç¼–è¾‘
- `with_streaming()` - å¯ç”¨/ç¦ç”¨æµå¼æ¨¡å¼
- `with_progress_throttle()` - è®¾ç½®è¿›åº¦æ›´æ–°é—´éš”
- `process_streaming_chat()` - ä½¿ç”¨å¼‚æ­¥ä»»åŠ¡ API å¤„ç†æ¶ˆæ¯
- `create_task()` - åˆ›å»ºå¼‚æ­¥ä»»åŠ¡
- `should_use_streaming()` - åˆ¤æ–­æ˜¯å¦ä½¿ç”¨æµå¼æ¨¡å¼

### Phase 5: ä¾èµ–æ›´æ–° âœ…

**ä¿®æ”¹æ–‡ä»¶**: `services/zero-channels/Cargo.toml`

æ–°å¢ä¾èµ–ï¼š
- `eventsource-client = "0.13"` - SSE å®¢æˆ·ç«¯
- `dashmap = "5.5"` - çº¿ç¨‹å®‰å…¨ HashMap

### Phase 6: æ¨¡å—å¯¼å‡º âœ…

**ä¿®æ”¹æ–‡ä»¶**: `services/zero-channels/src/lib.rs`

å¯¼å‡ºæ–°æ¨¡å—å’Œç±»å‹ï¼š
- `progress` å’Œ `sse` æ¨¡å—
- `ImProgressHandler`, `ProgressHandler`
- `SseTaskClient`, `TaskEvent`, `CreateTaskRequest` ç­‰

## æ¶æ„å›¾

```
ç”¨æˆ· IM æ¶ˆæ¯
     â”‚
     â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚   zero-channels â”‚
â”‚   (Telegram)    â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”˜
         â”‚ æ£€æµ‹ agent å‘½ä»¤
         â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”     POST /api/v1/tasks
â”‚   Bridge        â”‚â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¶ CodeCoder
â”‚ process_stream  â”‚
â”‚                 â”‚â—€â”€â”€â”€â”€â”€â”€â”€â”€ task_id â”€â”€â”€â”€â”€â”€â”€â”€â”€
â”‚                 â”‚
â”‚                 â”‚     GET /tasks/{id}/events (SSE)
â”‚                 â”‚â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¶ CodeCoder
â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”˜
         â”‚ TaskEvent
         â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ ImProgressHandlerâ”‚
â”‚                 â”‚
â”‚ â€¢ on_start()    â”‚â”€â”€â–¶ "ğŸš€ å¼€å§‹å¤„ç†..."
â”‚ â€¢ on_tool_use() â”‚â”€â”€â–¶ "ğŸ“„ è¯»å–æ–‡ä»¶ Read"
â”‚ â€¢ on_progress() â”‚â”€â”€â–¶ (ç¼–è¾‘æ¶ˆæ¯) "â³ processing..."
â”‚ â€¢ on_finish()   â”‚â”€â”€â–¶ "âœ… å®Œæ•´å“åº”"
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

## Bug ä¿®å¤

### SSE è¿æ¥è¶…æ—¶é—®é¢˜ï¼ˆ2026-02-25ï¼‰

**é—®é¢˜æè¿°**ï¼š
zero-channels è¿æ¥ CodeCoder SSE ç«¯ç‚¹æ—¶ï¼Œè¿æ¥é¢‘ç¹å›  "connection closed before message completed" é”™è¯¯æ–­å¼€ï¼Œè§¦å‘é‡è¯•ã€‚

**æ ¹æœ¬åŸå› **ï¼š
æœåŠ¡ç«¯ SSE ç«¯ç‚¹æœªå‘é€ keep-alive å¿ƒè·³ã€‚åœ¨ LLM å¤„ç†æœŸé—´ï¼ˆå¯èƒ½æŒç»­æ•°åç§’ï¼‰ï¼Œæ— æ•°æ®ä¼ è¾“å¯¼è‡´ HTTP è¿æ¥è¶…æ—¶ã€‚

**è§£å†³æ–¹æ¡ˆ**ï¼š
åœ¨ `packages/ccode/src/api/server/handlers/task.ts` çš„ `streamTaskEvents` å‡½æ•°ä¸­æ·»åŠ å¿ƒè·³æœºåˆ¶ï¼š
- æ¯ 15 ç§’å‘é€ SSE æ³¨é‡Š `: heartbeat\n\n`
- SSE è§„èŒƒä¸­æ³¨é‡Šï¼ˆä»¥ `:` å¼€å¤´çš„è¡Œï¼‰ç”¨äº keep-aliveï¼Œå®¢æˆ·ç«¯ä¼šå¿½ç•¥è¿™äº›è¡Œ

**ä¿®æ”¹æ–‡ä»¶**ï¼š`packages/ccode/src/api/server/handlers/task.ts`

## æµ‹è¯•çŠ¶æ€

- âœ… å•å…ƒæµ‹è¯•é€šè¿‡ï¼ˆSSE äº‹ä»¶è§£æã€è¿›åº¦å¤„ç†å™¨ï¼‰
- âœ… ä»£ç ç¼–è¯‘æ— é”™è¯¯
- âœ… SSE å¿ƒè·³æœºåˆ¶éªŒè¯é€šè¿‡
- â³ ç«¯åˆ°ç«¯é›†æˆæµ‹è¯•å¾…è¿›è¡Œ

## åç»­å·¥ä½œ

1. **é›†æˆæµ‹è¯•**ï¼šå‘é€ Telegram æ¶ˆæ¯ï¼ŒéªŒè¯è¿›åº¦æ›´æ–°æµç¨‹
2. **ç¡®è®¤è¯·æ±‚å¤„ç†**ï¼šå®ç° IM ä¸­çš„æƒé™ç¡®è®¤äº¤äº’ï¼ˆç›®å‰ä»…è®°å½•æ—¥å¿—ï¼‰
3. **å…¶ä»– IM æ¸ é“**ï¼šæ‰©å±•è¿›åº¦åé¦ˆåˆ° Feishuã€Discord ç­‰

## é…ç½®ç¤ºä¾‹

```json
{
  "channels": {
    "streaming_enabled": true,
    "progress_throttle_ms": 1000,
    "telegram": {
      "bot_token": "...",
      "allowed_users": ["*"]
    }
  }
}
```

## ä½¿ç”¨æ–¹å¼

ç”¨æˆ·åœ¨ Telegram å‘é€æ¶ˆæ¯åï¼Œå°†çœ‹åˆ°ï¼š

1. "ğŸš€ å¼€å§‹å¤„ç†..."
2. "ğŸ“„ è¯»å–æ–‡ä»¶ Read" (å·¥å…·è°ƒç”¨)
3. "ğŸ’» æ‰§è¡Œå‘½ä»¤ Bash" (å·¥å…·è°ƒç”¨)
4. å®Œæ•´çš„ AI å“åº”

è¿›åº¦æ›´æ–°ä¼šè‡ªåŠ¨èŠ‚æµï¼Œé¿å…è§¦å‘ Telegram API é™åˆ¶ã€‚
