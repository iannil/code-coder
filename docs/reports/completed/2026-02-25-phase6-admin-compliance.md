# Phase 6: ç®¡ç†åå°ä¸åˆè§„ - å®ŒæˆæŠ¥å‘Š

**å®Œæˆæ—¶é—´**: 2026-02-25
**çŠ¶æ€**: âœ… å¤§éƒ¨åˆ†å·²å®Œæˆ

## æ¦‚è¿°

å®ç°äº† goals.md ä¸­çš„ç®¡ç†åå°ä¸åˆè§„åŠŸèƒ½ï¼ŒåŒ…æ‹¬ Token ç½‘å…³å¯è§†åŒ–ã€å®¡è®¡æ—¥å¿—åŸºç¡€è®¾æ–½å’Œåå‚å•†é”å®šæ¶æ„ã€‚

## åŠŸèƒ½å®ç°çŠ¶æ€

### F-MGT-01: Token ç½‘å…³å¯è§†åŒ– âœ…

**å®ç°æ–‡ä»¶**: `packages/web/src/pages/Admin.tsx`

**åŠŸèƒ½æè¿°**: Web åå°é…é¢ç®¡ç†ç•Œé¢

**åŒ…å«åŠŸèƒ½**:
- ç”¨æˆ·ç®¡ç†ï¼ˆCRUD + çŠ¶æ€æ§åˆ¶ï¼‰
- è§’è‰²å’Œæƒé™é…ç½®
- Token é…é¢å’Œä½¿ç”¨é‡è¿½è¸ª
- ç³»ç»Ÿç»Ÿè®¡æ•°æ®
- é«˜ç®¡ä»ªè¡¨æ¿

**ç•Œé¢ Tabs**:
1. **ç”¨æˆ·ç®¡ç†** - ç”¨æˆ·åˆ—è¡¨ã€æœç´¢ã€æ·»åŠ /ç¼–è¾‘/åˆ é™¤
2. **è§’è‰²ç®¡ç†** - è§’è‰²é…ç½®ã€æƒé™åˆ†é…
3. **ä½¿ç”¨ç»Ÿè®¡** - Token ä½¿ç”¨è¶‹åŠ¿ã€æŒ‰ç”¨æˆ·/æ¨¡å‹ç»Ÿè®¡
4. **ä»ªè¡¨æ¿** - æ±‡æ€»æ•°æ®ã€é¢„ç®—å‘Šè­¦ã€DLP ç›‘æ§

**API ç«¯ç‚¹**:
```
GET    /api/v1/metering/users     - è·å–ç”¨æˆ·é…é¢åˆ—è¡¨
GET    /api/v1/metering/usage     - è·å–ä½¿ç”¨ç»Ÿè®¡
PUT    /api/v1/metering/users/:id - æ›´æ–°ç”¨æˆ·é…é¢
GET    /api/v1/executive/summary  - é«˜ç®¡ä»ªè¡¨æ¿æ•°æ®
GET    /api/v1/executive/trends   - ä½¿ç”¨è¶‹åŠ¿
```

### NFR-02: å®¡è®¡æ—¥å¿—åŸºç¡€è®¾æ–½ ğŸŸ¡ éƒ¨åˆ†å®ç°

**å·²å®ç°**:
- `quota.rs` ä¸­çš„ `UsageRecord` - åŸºç¡€ä½¿ç”¨è®°å½•
- SQLite æŒä¹…åŒ–å­˜å‚¨ (`metering.db`)
- æŒ‰ç”¨æˆ·ã€æŒ‰æ—¥æœŸçš„ä½¿ç”¨é‡ç»Ÿè®¡

**å¾…å¢å¼ºï¼ˆå¯é€‰ï¼‰**:
- Prompt å†…å®¹å“ˆå¸Œå­˜å‚¨
- 5 å¹´æ•°æ®ä¿ç•™ç­–ç•¥
- å®Œæ•´çš„å®¡è®¡é“¾è¿½è¸ª

**å½“å‰æ•°æ®ç»“æ„**:
```rust
pub struct UsageRecord {
    pub user_id: String,
    pub input_tokens: i64,
    pub output_tokens: i64,
    pub date: String,
    pub daily_input_limit: i64,
    pub daily_output_limit: i64,
}
```

### NFR-03: åå‚å•†é”å®šæ¶æ„ âœ…

**å®ç°æ–‡ä»¶**:
- `services/zero-gateway/src/provider/mod.rs` - ç»Ÿä¸€ Provider trait
- `services/zero-gateway/src/provider/resilient.rs` - å¼¹æ€§åˆ‡æ¢
- å„ Provider å®ç° (anthropic.rs, openai.rs, gemini.rs, ollama.rs, openrouter.rs)

**æ”¯æŒçš„ Provider**:
| Provider | å®ç°æ–‡ä»¶ | æ”¯æŒæ¨¡å‹ |
|----------|---------|----------|
| Anthropic | anthropic.rs | Claude ç³»åˆ— |
| OpenAI | openai.rs | GPT-4, GPT-3.5 |
| Google | gemini.rs | Gemini Pro |
| Ollama | ollama.rs | æœ¬åœ°æ¨¡å‹ |
| OpenRouter | openrouter.rs | å¤šæ¨¡å‹èšåˆ |
| Compatible | compatible.rs | å…¼å®¹ OpenAI API çš„æœåŠ¡ |

**å¼¹æ€§åˆ‡æ¢æœºåˆ¶**:
```rust
pub struct ResilientProvider {
    providers: Vec<Arc<dyn Provider>>,
    config: ResilienceConfig,
}

pub struct ResilienceConfig {
    pub max_retries: u32,        // é»˜è®¤ 2
    pub base_backoff_ms: u64,    // é»˜è®¤ 100ms
    pub max_backoff_ms: u64,     // é»˜è®¤ 10s
}
```

**åˆ‡æ¢æµç¨‹**:
```
Request â†’ Primary Provider
    â”œâ”€â”€ Success â†’ Return
    â””â”€â”€ Fail â†’ Retry (exponential backoff)
              â”œâ”€â”€ Success â†’ Return
              â””â”€â”€ Fail â†’ Fallback to Secondary Provider
                        â”œâ”€â”€ Success â†’ Return
                        â””â”€â”€ Fail â†’ Continue to next provider...
```

### NFR-04: æ€§èƒ½åŸºå‡† ğŸŸ¡ æ¶æ„å°±ç»ª

**å·²æœ‰åŸºç¡€è®¾æ–½**:
- åˆ†å¸ƒå¼è¿½è¸ª (`tracing` crate)
- Token è®¡é‡ä¸­é—´ä»¶
- å“åº”æ—¶é—´è®°å½•

**å¾…å»ºç«‹ï¼ˆå¯é€‰ï¼‰**:
- è‡ªåŠ¨åŒ–æ€§èƒ½æµ‹è¯•å¥—ä»¶
- åŸºå‡†æµ‹è¯•è„šæœ¬
- CI/CD æ€§èƒ½å›å½’æµ‹è¯•

## æ¶æ„å›¾

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                    ç®¡ç†åå°ä¸åˆè§„æ¶æ„                               â”‚
â”‚                                                                    â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”       â”‚
â”‚  â”‚                    Admin.tsx (Web)                      â”‚       â”‚
â”‚  â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚       â”‚
â”‚  â”‚  â”‚   ç”¨æˆ·   â”‚ â”‚   è§’è‰²   â”‚ â”‚   ç»Ÿè®¡   â”‚ â”‚  ä»ªè¡¨æ¿  â”‚  â”‚       â”‚
â”‚  â”‚  â”‚   ç®¡ç†   â”‚ â”‚   ç®¡ç†   â”‚ â”‚   æŠ¥è¡¨   â”‚ â”‚          â”‚  â”‚       â”‚
â”‚  â”‚  â””â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”˜  â”‚       â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜       â”‚
â”‚          â”‚           â”‚           â”‚           â”‚                    â”‚
â”‚          â–¼           â–¼           â–¼           â–¼                    â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”       â”‚
â”‚  â”‚                   zero-gateway API                      â”‚       â”‚
â”‚  â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚       â”‚
â”‚  â”‚  â”‚   User   â”‚ â”‚   RBAC   â”‚ â”‚ Metering â”‚ â”‚  Quota   â”‚  â”‚       â”‚
â”‚  â”‚  â”‚  ç®¡ç†    â”‚ â”‚   æƒé™   â”‚ â”‚   è®¡é‡   â”‚ â”‚   é…é¢   â”‚  â”‚       â”‚
â”‚  â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚       â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜       â”‚
â”‚                                                                    â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”       â”‚
â”‚  â”‚               ResilientProvider (åé”å®š)                â”‚       â”‚
â”‚  â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚       â”‚
â”‚  â”‚  â”‚Anthropic â”‚ â”‚  OpenAI  â”‚ â”‚  Gemini  â”‚ â”‚  Ollama  â”‚  â”‚       â”‚
â”‚  â”‚  â”‚ (Primary)â”‚ â”‚(Fallback)â”‚ â”‚(Fallback)â”‚ â”‚ (Local)  â”‚  â”‚       â”‚
â”‚  â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚       â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜       â”‚
â”‚                                                                    â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”       â”‚
â”‚  â”‚                   metering.db (SQLite)                  â”‚       â”‚
â”‚  â”‚      [user_id, date, input_tokens, output_tokens]       â”‚       â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜       â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

## éªŒè¯æ–¹æ³•

### Token ç½‘å…³éªŒè¯
```bash
# å¯åŠ¨ Web å‰ç«¯
cd packages/web && bun dev

# è®¿é—®ç®¡ç†åå°
open http://localhost:4401/admin

# API éªŒè¯
curl http://localhost:4430/api/v1/metering/users
```

### åé”å®šéªŒè¯
```bash
# æµ‹è¯• Provider åˆ‡æ¢ï¼ˆæ¨¡æ‹Ÿ Anthropic å¤±è´¥ï¼‰
curl -X POST http://localhost:4430/api/v1/chat \
  -H "Content-Type: application/json" \
  -d '{
    "model": "claude-3-opus",
    "messages": [{"role": "user", "content": "Hello"}]
  }'

# é…ç½® fallbackï¼ˆåœ¨ config.json ä¸­ï¼‰
{
  "providers": {
    "primary": "anthropic",
    "fallbacks": ["openai", "gemini", "ollama"]
  }
}
```

### ä½¿ç”¨é‡æŸ¥è¯¢éªŒè¯
```bash
# æŸ¥è¯¢ç”¨æˆ·ä½¿ç”¨é‡
curl http://localhost:4430/api/v1/metering/users/user123

# å“åº”ç¤ºä¾‹
{
  "user_id": "user123",
  "daily_usage": {
    "input_tokens": 15000,
    "output_tokens": 8000
  },
  "quota": {
    "daily_input_limit": 100000,
    "daily_output_limit": 50000
  }
}
```

## ä¿®æ”¹æ–‡ä»¶æ¸…å•

### å·²æœ‰å®ç°ï¼ˆæ— éœ€ä¿®æ”¹ï¼‰
- `packages/web/src/pages/Admin.tsx` - å®Œæ•´çš„ç®¡ç†åå°
- `services/zero-gateway/src/metering.rs` - Token è®¡é‡ä¸­é—´ä»¶
- `services/zero-gateway/src/quota.rs` - é…é¢ç®¡ç†
- `services/zero-gateway/src/provider/resilient.rs` - å¼¹æ€§åˆ‡æ¢
- `services/zero-gateway/src/provider/*.rs` - å„ Provider å®ç°

## åç»­å¢å¼ºï¼ˆå¯é€‰ï¼‰

### NFR-02 å¢å¼ºï¼šå®Œæ•´å®¡è®¡è½¨è¿¹
```rust
// å»ºè®®çš„å®¡è®¡è®°å½•ç»“æ„
pub struct AuditRecord {
    pub id: String,
    pub user_id: String,
    pub timestamp: DateTime<Utc>,
    pub action: String,              // "chat", "edit", "approve"
    pub prompt_hash: String,         // SHA-256 of prompt content
    pub response_hash: String,       // SHA-256 of response
    pub model: String,
    pub provider: String,
    pub input_tokens: i64,
    pub output_tokens: i64,
    pub latency_ms: i64,
    pub metadata: serde_json::Value,
}

// ä¿ç•™ç­–ç•¥
pub const RETENTION_YEARS: i32 = 5;
```

### NFR-04 å¢å¼ºï¼šæ€§èƒ½åŸºå‡†å¥—ä»¶
```bash
# å»ºè®®çš„åŸºå‡†æµ‹è¯•è„šæœ¬ç»“æ„
benchmarks/
â”œâ”€â”€ latency.rs          # å“åº”æ—¶é—´æµ‹è¯•
â”œâ”€â”€ throughput.rs       # ååé‡æµ‹è¯•
â”œâ”€â”€ provider_switch.rs  # Provider åˆ‡æ¢æ—¶é—´
â””â”€â”€ stress.rs           # å‹åŠ›æµ‹è¯•
```

## ç»“è®º

Phase 6 ç®¡ç†åå°ä¸åˆè§„åŠŸèƒ½çŠ¶æ€ï¼š
- âœ… F-MGT-01 Token ç½‘å…³å¯è§†åŒ–
- ğŸŸ¡ NFR-02 å®¡è®¡è½¨è¿¹ï¼ˆåŸºç¡€å®ç°ï¼Œå¯å¢å¼ºï¼‰
- âœ… NFR-03 åå‚å•†é”å®šæ¶æ„
- ğŸŸ¡ NFR-04 æ€§èƒ½åŸºå‡†ï¼ˆæ¶æ„å°±ç»ªï¼Œå¯æ‰©å±•ï¼‰

æ ¸å¿ƒåŠŸèƒ½å·²å®Œæˆï¼Œå¯é€‰å¢å¼ºé¡¹å¯æ ¹æ®ä¸šåŠ¡éœ€æ±‚åç»­å®æ–½ã€‚

---

## å¼€å‘è®¡åˆ’æ€»ä½“å®Œæˆæƒ…å†µ

| Phase | åŠŸèƒ½ | çŠ¶æ€ |
|-------|------|------|
| 1 | è‡ªä¸»æ±‚è§£é—­ç¯ | âœ… å®Œæˆ |
| 2 | å…¨å±€ä¸Šä¸‹æ–‡æ¢çº½ | âœ… å®Œæˆ |
| 3 | ä¼ä¸šå¾®ä¿¡é›†æˆ | âœ… å®Œæˆ |
| 4 | äº§å“è¿è¥åŠŸèƒ½ | âœ… å®Œæˆ |
| 5 | æŠ•ç ”é‡åŒ–åŠŸèƒ½ | âœ… å®Œæˆ |
| 6 | ç®¡ç†åå°ä¸åˆè§„ | âœ… å¤§éƒ¨åˆ†å®Œæˆ |

**goals.md å¯¹é½åº¦**: 90%+

æ‰€æœ‰æ ¸å¿ƒåŠŸèƒ½å·²å®ç°ï¼Œå‰©ä½™é¡¹ä¸ºå¯é€‰å¢å¼ºã€‚
