# CodeCoder ASCII 架构图

## 系统总览

```
╔══════════════════════════════════════════════════════════════════════════════════════╗
║                              CodeCoder 系统架构总览                                   ║
╠══════════════════════════════════════════════════════════════════════════════════════╣
║                                                                                       ║
║  ┌─────────────────────────────────────────────────────────────────────────────────┐ ║
║  │                              用户接入层                                          │ ║
║  │   ┌─────────┐   ┌─────────┐   ┌─────────┐   ┌─────────┐   ┌─────────┐          │ ║
║  │   │   TUI   │   │   Web   │   │   CLI   │   │Telegram │   │ Discord │          │ ║
║  │   │ :4400   │   │ :4401   │   │         │   │  Bot    │   │   Bot   │          │ ║
║  │   └────┬────┘   └────┬────┘   └────┬────┘   └────┬────┘   └────┬────┘          │ ║
║  └────────┼─────────────┼─────────────┼─────────────┼─────────────┼────────────────┘ ║
║           └─────────────┴──────┬──────┴─────────────┴─────────────┘                  ║
║                                ▼                                                      ║
║  ┌─────────────────────────────────────────────────────────────────────────────────┐ ║
║  │                              核心服务层 (TypeScript/Bun)                         │ ║
║  │   ┌──────────────┐   ┌──────────────┐   ┌──────────────┐   ┌──────────────┐    │ ║
║  │   │  API Server  │   │ Agent Engine │   │  MCP Server  │   │ Memory System│    │ ║
║  │   │    :4400     │◄─►│  (23 Agents) │◄─►│    :4420     │◄─►│ (Markdown)   │    │ ║
║  │   └──────────────┘   └──────┬───────┘   └──────────────┘   └──────────────┘    │ ║
║  └─────────────────────────────┼───────────────────────────────────────────────────┘ ║
║                                ▼                                                      ║
║  ┌─────────────────────────────────────────────────────────────────────────────────┐ ║
║  │                              AI Provider 适配层                                  │ ║
║  │   ┌───────┐ ┌───────┐ ┌───────┐ ┌───────┐ ┌───────┐ ┌───────┐ ┌───────┐       │ ║
║  │   │Claude │ │ GPT   │ │Gemini │ │Ollama │ │ Groq  │ │Mistral│ │ ...   │       │ ║
║  │   └───────┘ └───────┘ └───────┘ └───────┘ └───────┘ └───────┘ └───────┘       │ ║
║  └─────────────────────────────────────────────────────────────────────────────────┘ ║
║                                                                                       ║
║  ┌─────────────────────────────────────────────────────────────────────────────────┐ ║
║  │                              Rust 微服务层                                       │ ║
║  │              ┌──────────────────────────────────────────────────┐               │ ║
║  │              │              Zero Daemon :4402                   │               │ ║
║  │              └───────────────────────┬──────────────────────────┘               │ ║
║  │   ┌──────────────────┬───────────────┼───────────────┬──────────────────┐      │ ║
║  │   ▼                  ▼               ▼               ▼                  ▼      │ ║
║  │ ┌────────┐      ┌────────┐      ┌────────┐      ┌────────┐      ┌────────┐    │ ║
║  │ │Gateway │      │Channels│      │Workflow│      │ Trading│      │Browser │    │ ║
║  │ │ :4430  │      │ :4431  │      │ :4432  │      │ :4434  │      │ :4433  │    │ ║
║  │ └────────┘      └────────┘      └────────┘      └────────┘      └────────┘    │ ║
║  │              ┌──────────────────────────────────────────────────┐               │ ║
║  │              │              Zero Common (共享库)                │               │ ║
║  │              └──────────────────────────────────────────────────┘               │ ║
║  └─────────────────────────────────────────────────────────────────────────────────┘ ║
║                                                                                       ║
║  ┌─────────────────────────────────────────────────────────────────────────────────┐ ║
║  │                              基础设施层                                          │ ║
║  │   ┌──────────────┐   ┌──────────────┐   ┌──────────────┐   ┌──────────────┐    │ ║
║  │   │    Redis     │   │   SQLite     │   │    Docker    │   │   Whisper    │    │ ║
║  │   │    :6379     │   │  (内置)      │   │   (沙箱)     │   │   :4403      │    │ ║
║  │   └──────────────┘   └──────────────┘   └──────────────┘   └──────────────┘    │ ║
║  └─────────────────────────────────────────────────────────────────────────────────┘ ║
╚══════════════════════════════════════════════════════════════════════════════════════╝
```

## Agent 系统

```
╔══════════════════════════════════════════════════════════════════════════════════════╗
║                              Agent 系统架构 (23个Agent)                               ║
╠══════════════════════════════════════════════════════════════════════════════════════╣
║                                                                                       ║
║  ┌─────────────────────────── Agent 注册中心 ─────────────────────────────┐          ║
║  │   AgentRegistry ──► Fuse.js 模糊搜索 ──► 触发器匹配                    │          ║
║  │                     (keyword/pattern/event/context)                     │          ║
║  └─────────────────────────────────┬───────────────────────────────────────┘          ║
║                                    │                                                  ║
║  ┌─────────────────────────────────┴───────────────────────────────────────┐         ║
║  │  ┌──────────────────┐  ┌──────────────────┐  ┌──────────────────┐       │         ║
║  │  │   主模式 Agent   │  │  工程质量 Agent  │  │  逆向工程 Agent  │       │         ║
║  │  ├──────────────────┤  ├──────────────────┤  ├──────────────────┤       │         ║
║  │  │ 🔨 build         │  │ 🔍 code-reviewer │  │ code-reverse     │       │         ║
║  │  │ 📋 plan          │  │ 🔒 security-rev  │  │ jar-code-reverse │       │         ║
║  │  │                  │  │ 🧪 tdd-guide     │  │                  │       │         ║
║  │  │                  │  │ 🏗️ architect     │  │                  │       │         ║
║  │  │                  │  │ 🔭 explore       │  │                  │       │         ║
║  │  └──────────────────┘  └──────────────────┘  └──────────────────┘       │         ║
║  │                                                                          │         ║
║  │  ┌──────────────────┐  ┌──────────────────────────────────────────┐     │         ║
║  │  │  内容创作 Agent  │  │           祝融说系列 Agent (ZRS)          │     │         ║
║  │  ├──────────────────┤  ├──────────────────────────────────────────┤     │         ║
║  │  │ ✍️ writer        │  │ 👁️ observer    │ 🎯 decision             │     │         ║
║  │  │ 📝 proofreader   │  │ 📊 macro       │ 📈 trader               │     │         ║
║  │  │                  │  │ picker         │ miniproduct             │     │         ║
║  │  │                  │  │ ai-engineer                              │     │         ║
║  │  └──────────────────┘  └──────────────────────────────────────────┘     │         ║
║  │                                                                          │         ║
║  │  ┌──────────────────┐  ┌──────────────────┐                             │         ║
║  │  │   系统 Agent     │  │   隐藏 Agent     │                             │         ║
║  │  ├──────────────────┤  ├──────────────────┤                             │         ║
║  │  │ 🤖 autonomous    │  │ compaction       │                             │         ║
║  │  │ 💬 general       │  │ title / summary  │                             │         ║
║  │  └──────────────────┘  └──────────────────┘                             │         ║
║  └──────────────────────────────────────────────────────────────────────────┘         ║
╚══════════════════════════════════════════════════════════════════════════════════════╝
```

## 数据流向

```
┌─────────────────────────────────────────────────────────────────────────────┐
│                              请求处理流程                                    │
└─────────────────────────────────────────────────────────────────────────────┘

  用户输入                                                         响应输出
     │                                                                 ▲
     ▼                                                                 │
┌─────────┐    ┌─────────────┐    ┌─────────────┐    ┌─────────────┐  │
│  TUI/   │───►│  API Server │───►│   Agent     │───►│  AI Provider│──┘
│  Web/   │    │   :4400     │    │   引擎      │    │  (Claude等) │
│  CLI    │    └──────┬──────┘    └──────┬──────┘    └─────────────┘
└─────────┘           │                  │
                      │                  │
                      ▼                  ▼
               ┌─────────────┐    ┌─────────────┐
               │  记忆系统   │    │  工具执行   │
               │ (读取上下文)│    │ (Bash/File/ │
               │             │    │  Git/LSP)   │
               └─────────────┘    └─────────────┘


┌─────────────────────────────────────────────────────────────────────────────┐
│                              外部消息处理流程                                │
└─────────────────────────────────────────────────────────────────────────────┘

  Telegram/Discord/...
         │
         ▼
  ┌─────────────┐    ┌─────────────┐    ┌─────────────┐
  │Zero Channels│───►│Zero Gateway │───►│  API Server │───► Agent 处理
  │   :4431     │    │   :4430     │    │   :4400     │
  └─────────────┘    └──────┬──────┘    └─────────────┘
                            │
                            ▼
                     ┌─────────────┐
                     │   Redis     │  (会话状态)
                     │   :6379     │
                     └─────────────┘
```

## 端口映射表

```
┌────────────────────────────────────────────────────────────────────┐
│                         端口分配表                                  │
├─────────────┬──────────┬───────────────────────────────────────────┤
│   端口      │  服务    │  说明                                     │
├─────────────┼──────────┼───────────────────────────────────────────┤
│   4400      │  API     │  CodeCoder API Server (Bun/TypeScript)   │
│   4401      │  Web     │  Web Frontend (Vite/React)               │
│   4402      │  Daemon  │  Zero CLI Daemon (Rust 进程编排器)        │
│   4403      │  Whisper │  Faster Whisper STT Server (Docker)      │
├─────────────┼──────────┼───────────────────────────────────────────┤
│   4420      │  MCP     │  MCP Server (HTTP JSON-RPC)              │
├─────────────┼──────────┼───────────────────────────────────────────┤
│   4430      │  Gateway │  Zero Gateway (认证/路由/配额)            │
│   4431      │  Channels│  Zero Channels (IM 渠道适配)              │
│   4432      │  Workflow│  Zero Workflow (Webhook/Cron/Git)        │
│   4433      │  Browser │  Zero Browser (浏览器自动化)              │
│   4434      │  Trading │  Zero Trading (交易系统，开发中)          │
├─────────────┼──────────┼───────────────────────────────────────────┤
│   6379      │  Redis   │  Redis Server (会话存储)                  │
└─────────────┴──────────┴───────────────────────────────────────────┘
```

## ccode 与 zero-* 关系

```
┌─────────────────────────────────────────────────────────────────────────────────────┐
│                              依赖方向                                                │
├─────────────────────────────────────────────────────────────────────────────────────┤
│                                                                                      │
│                         ┌─────────────────────────────────┐                         │
│                         │         packages/ccode          │                         │
│                         │       (AI 智能核心)              │                         │
│                         │  • 不依赖任何 zero-* 服务       │                         │
│                         │  • 可独立运行 (TUI/CLI)         │                         │
│                         └───────────────┬─────────────────┘                         │
│                                         │                                            │
│                           被调用 (HTTP) │ 调用 (HTTP)                                │
│                                         │                                            │
│         ┌───────────────────────────────┼───────────────────────────────┐           │
│         ▼                               ▼                               ▼           │
│   ┌───────────────┐             ┌───────────────┐             ┌───────────────┐    │
│   │zero-channels  │             │zero-workflow  │             │zero-gateway   │    │
│   │  (渠道层)     │             │  (调度层)     │             │  (网关层)     │    │
│   └───────┬───────┘             └───────┬───────┘             └───────┬───────┘    │
│           └─────────────────────────────┼─────────────────────────────┘            │
│                                         ▼                                           │
│                         ┌─────────────────────────────────┐                         │
│                         │        zero-common              │                         │
│                         │       (共享基础库)               │                         │
│                         └─────────────────────────────────┘                         │
│                                                                                      │
│   关系: ccode = 大脑 (思考)，zero-* = 感官和肢体 (感知、执行)                       │
│                                                                                      │
└─────────────────────────────────────────────────────────────────────────────────────┘
```
