# CodeCoder 系统架构

> 生成时间: 2026-02-25

## 1. 项目概述

CodeCoder 是一个融合工程能力与决策智慧的个人工作台，采用 **Turborepo + Bun** 构建的 Monorepo 架构，支持多种 AI 提供商，提供 CLI/TUI 界面和客户端/服务器架构。

### 核心定位

| 层级 | 能力 |
|------|------|
| **工程层** | 代码审查、安全分析、TDD、架构设计、逆向工程 |
| **领域层** | 宏观经济、交易分析、选品策略、极小产品、AI 工程 |
| **思维层** | 祝融说哲学体系、CLOSE 决策框架、观察者理论 |

---

## 2. 系统架构总览

```
╔══════════════════════════════════════════════════════════════════════════════════════╗
║                              CodeCoder 系统架构总览                                   ║
╠══════════════════════════════════════════════════════════════════════════════════════╣
║                                                                                       ║
║  ┌─────────────────────────────────────────────────────────────────────────────────┐ ║
║  │                              用户接入层                                          │ ║
║  │   ┌─────────┐   ┌─────────┐   ┌─────────┐   ┌─────────┐   ┌─────────┐          │ ║
║  │   │   TUI   │   │   Web   │   │   CLI   │   │Telegram │   │ Discord │          │ ║
║  │   │ :4400   │   │ :4401   │   │         │   │  Bot    │   │   Bot   │          │ ║
║  │   └────┬────┘   └────┬────┘   └────┬────┘   └────┬────┘   └────┬────┘          │ ║
║  │        │             │             │             │             │                │ ║
║  └────────┼─────────────┼─────────────┼─────────────┼─────────────┼────────────────┘ ║
║           │             │             │             │             │                  ║
║           └─────────────┴──────┬──────┴─────────────┴─────────────┘                  ║
║                                │                                                      ║
║                                ▼                                                      ║
║  ┌─────────────────────────────────────────────────────────────────────────────────┐ ║
║  │                              核心服务层 (TypeScript/Bun)                         │ ║
║  │                                                                                  │ ║
║  │   ┌──────────────┐   ┌──────────────┐   ┌──────────────┐   ┌──────────────┐    │ ║
║  │   │  API Server  │   │ Agent Engine │   │  MCP Server  │   │ Memory System│    │ ║
║  │   │    :4400     │◄─►│  (23 Agents) │◄─►│    :4420     │◄─►│ (Markdown +  │    │ ║
║  │   │              │   │              │   │              │   │   SQLite)    │    │ ║
║  │   └──────────────┘   └──────┬───────┘   └──────────────┘   └──────────────┘    │ ║
║  │                             │                                                   │ ║
║  └─────────────────────────────┼───────────────────────────────────────────────────┘ ║
║                                │                                                      ║
║                                ▼                                                      ║
║  ┌─────────────────────────────────────────────────────────────────────────────────┐ ║
║  │                              AI Provider 适配层                                  │ ║
║  │   ┌───────┐ ┌───────┐ ┌───────┐ ┌───────┐ ┌───────┐ ┌───────┐ ┌───────┐       │ ║
║  │   │Claude │ │ GPT   │ │Gemini │ │Ollama │ │ Groq  │ │Mistral│ │ ...   │       │ ║
║  │   └───────┘ └───────┘ └───────┘ └───────┘ └───────┘ └───────┘ └───────┘       │ ║
║  └─────────────────────────────────────────────────────────────────────────────────┘ ║
║                                                                                       ║
║  ┌─────────────────────────────────────────────────────────────────────────────────┐ ║
║  │                              Rust 微服务层                                       │ ║
║  │                                                                                  │ ║
║  │              ┌──────────────────────────────────────────────────┐               │ ║
║  │              │              Zero Daemon :4402                   │               │ ║
║  │              │              (进程编排器)                         │               │ ║
║  │              └───────────────────────┬──────────────────────────┘               │ ║
║  │                                      │                                          │ ║
║  │   ┌──────────────────┬───────────────┼───────────────┬──────────────────┐      │ ║
║  │   │                  │               │               │                  │      │ ║
║  │   ▼                  ▼               ▼               ▼                  ▼      │ ║
║  │ ┌────────┐      ┌────────┐      ┌────────┐      ┌────────┐      ┌────────┐    │ ║
║  │ │Gateway │      │Channels│      │Workflow│      │ Trading│      │Browser │    │ ║
║  │ │ :4430  │      │ :4431  │      │ :4432  │      │ :4434  │      │ :4433  │    │ ║
║  │ └────────┘      └────────┘      └────────┘      └────────┘      └────────┘    │ ║
║  │                                                                                  │ ║
║  │              ┌──────────────────────────────────────────────────┐               │ ║
║  │              │              Zero Common (共享库)                │               │ ║
║  │              │  config | logging | security | bus | audit       │               │ ║
║  │              └──────────────────────────────────────────────────┘               │ ║
║  │                                                                                  │ ║
║  └─────────────────────────────────────────────────────────────────────────────────┘ ║
║                                                                                       ║
║  ┌─────────────────────────────────────────────────────────────────────────────────┐ ║
║  │                              基础设施层                                          │ ║
║  │   ┌──────────────┐   ┌──────────────┐   ┌──────────────┐   ┌──────────────┐    │ ║
║  │   │    Redis     │   │   SQLite     │   │    Docker    │   │   Whisper    │    │ ║
║  │   │    :6379     │   │  (各服务内置) │   │   (沙箱)     │   │   :4403      │    │ ║
║  │   │  会话/事件   │   │  持久化存储  │   │  安全执行    │   │   语音转写   │    │ ║
║  │   └──────────────┘   └──────────────┘   └──────────────┘   └──────────────┘    │ ║
║  └─────────────────────────────────────────────────────────────────────────────────┘ ║
║                                                                                       ║
╚══════════════════════════════════════════════════════════════════════════════════════╝
```

### 2.1 技术栈一览

| 组件 | 技术选型 | 说明 |
|------|----------|------|
| **运行时** | Bun 1.3+, Rust 1.75+ | TypeScript 用 Bun，微服务用 Rust |
| **构建系统** | Turborepo (TS), Cargo Workspace (Rust) | 增量构建 + 并行执行 |
| **前端** | React (Web), Solid.js + OpenTUI (终端) | TailwindCSS 样式 |
| **后端** | Hono (TS HTTP), Axum (Rust HTTP) | 高性能 HTTP 框架 |
| **AI 集成** | Vercel AI SDK + 多提供商 | 统一的 AI 调用接口 |
| **协议** | MCP (Model Context Protocol) | 模型上下文协议 |

### 2.2 端口分配

```
核心服务 (4400-4409):
  ├── 4400: CodeCoder API Server (Bun/TypeScript)
  ├── 4401: Web Frontend (Vite/React)
  ├── 4402: Zero CLI Daemon (Rust, 进程编排器)
  └── 4403: Faster Whisper Server (Docker)

协议服务 (4420-4429):
  └── 4420: MCP Server (HTTP)

Rust 微服务 (4430-4439):
  ├── 4430: Zero Gateway (认证/路由/配额/MCP/Webhook)
  ├── 4431: Zero Channels (Telegram/Discord/Slack)
  ├── 4432: Zero Workflow (Webhook/Cron/Git)
  ├── 4433: Zero Browser (浏览器自动化)
  └── 4434: Zero Trading (交易系统，开发中)
```

---

## 3. 目录结构分析

```
codecoder/
│
├── packages/                          # TypeScript 包
│   │
│   ├── ccode/                         # 核心 CLI (入口点)
│   │   ├── src/
│   │   │   ├── index.ts               # ◄── 主入口
│   │   │   ├── agent/
│   │   │   │   ├── agent.ts           # Agent 定义
│   │   │   │   ├── registry.ts        # Agent 注册
│   │   │   │   └── prompt/*.txt       # Prompt 文件
│   │   │   ├── autonomous/            # 自主执行
│   │   │   ├── cli/cmd/               # CLI 命令
│   │   │   │   └── tui/               # TUI (Solid.js)
│   │   │   ├── context/               # 上下文
│   │   │   ├── memory/                # 内存管理
│   │   │   ├── memory-markdown/       # Markdown 记忆
│   │   │   ├── mcp/                   # MCP 集成
│   │   │   ├── provider/              # AI Provider
│   │   │   └── tool/                  # 工具定义
│   │   └── test/
│   │
│   ├── memory/                        # 统一记忆模块
│   ├── util/                          # 共享工具
│   └── web/                           # Web 前端 (React)
│
├── services/                          # Rust 微服务
│   │
│   ├── zero-cli/                      # CLI + Daemon
│   ├── zero-gateway/                  # 网关 :4430
│   ├── zero-channels/                 # 渠道 :4431
│   ├── zero-workflow/                 # 工作流 :4432
│   ├── zero-browser/                  # 浏览器 :4433
│   ├── zero-trading/                  # 交易 :4434 (开发中)
│   ├── zero-common/                   # 共享库
│   ├── zero-agent/                    # Agent 执行
│   ├── zero-memory/                   # 持久化
│   ├── zero-tools/                    # 工具
│   └── Cargo.toml                     # Workspace 配置
│
├── memory/                            # 项目记忆
│   ├── daily/                         # 每日笔记
│   └── MEMORY.md                      # 长期记忆
│
├── docs/                              # 文档
├── script/                            # 构建脚本
├── ops.sh                             # 运维脚本
├── turbo.json                         # Turborepo
└── package.json                       # 根配置
```

---

## 4. Agent 系统架构

```
╔══════════════════════════════════════════════════════════════════════════════════════╗
║                              Agent 系统架构 (23个Agent)                               ║
╠══════════════════════════════════════════════════════════════════════════════════════╣
║                                                                                       ║
║  ┌─────────────────────────── Agent 注册中心 ─────────────────────────────┐          ║
║  │                                                                         │          ║
║  │   AgentRegistry ──► Fuse.js 模糊搜索 ──► 触发器匹配                    │          ║
║  │                     (keyword/pattern/event/context)                     │          ║
║  └─────────────────────────────────┬───────────────────────────────────────┘          ║
║                                    │                                                  ║
║  ┌─────────────────────────────────┴───────────────────────────────────────┐         ║
║  │                                                                          │         ║
║  │  ┌──────────────────┐  ┌──────────────────┐  ┌──────────────────┐       │         ║
║  │  │   主模式 Agent   │  │  工程质量 Agent  │  │  逆向工程 Agent  │       │         ║
║  │  ├──────────────────┤  ├──────────────────┤  ├──────────────────┤       │         ║
║  │  │ build            │  │ code-reviewer    │  │ code-reverse     │       │         ║
║  │  │ plan             │  │ security-reviewer│  │ jar-code-reverse │       │         ║
║  │  │                  │  │ tdd-guide        │  │                  │       │         ║
║  │  │                  │  │ architect        │  │                  │       │         ║
║  │  │                  │  │ explore          │  │                  │       │         ║
║  │  └──────────────────┘  └──────────────────┘  └──────────────────┘       │         ║
║  │                                                                          │         ║
║  │  ┌──────────────────┐  ┌──────────────────────────────────────────┐     │         ║
║  │  │  内容创作 Agent  │  │           祝融说系列 Agent (ZRS)          │     │         ║
║  │  ├──────────────────┤  ├──────────────────────────────────────────┤     │         ║
║  │  │ writer           │  │ observer       │ decision                │     │         ║
║  │  │ proofreader      │  │ macro          │ trader                  │     │         ║
║  │  │                  │  │ picker         │ miniproduct             │     │         ║
║  │  │                  │  │ ai-engineer                              │     │         ║
║  │  └──────────────────┘  └──────────────────────────────────────────┘     │         ║
║  │                                                                          │         ║
║  │  ┌──────────────────┐  ┌──────────────────┐                             │         ║
║  │  │   系统 Agent     │  │   隐藏 Agent     │                             │         ║
║  │  ├──────────────────┤  ├──────────────────┤                             │         ║
║  │  │ autonomous       │  │ compaction       │                             │         ║
║  │  │ general          │  │ title            │                             │         ║
║  │  │ synton-assistant │  │ summary          │                             │         ║
║  │  └──────────────────┘  └──────────────────┘                             │         ║
║  │                                                                          │         ║
║  └──────────────────────────────────────────────────────────────────────────┘         ║
║                                                                                       ║
╚══════════════════════════════════════════════════════════════════════════════════════╝
```

### 4.1 Agent 分类 (23 个)

| 分类 | Agent | 用途 |
|------|-------|------|
| **主模式** | build, plan | 主要开发和规划 |
| **逆向工程** | code-reverse, jar-code-reverse | 代码逆向分析 |
| **工程质量** | code-reviewer, security-reviewer, tdd-guide, architect, explore | 代码质量保障 |
| **内容创作** | writer, proofreader | 长文写作与校对 |
| **祝融说系列** | observer, decision, macro, trader, picker, miniproduct, ai-engineer | 决策与领域咨询 |
| **系统辅助** | autonomous, general, synton-assistant | 自主执行与辅助 |
| **隐藏系统** | compaction, title, summary | 内部功能 |

### 4.2 Agent 注册机制

```typescript
// packages/ccode/src/agent/registry.ts
export class AgentRegistry {
  // 使用 Fuse.js 实现模糊搜索
  private searchIndex: Fuse<AgentMetadata>

  // 触发器匹配: keyword, pattern, event, context
  findByTrigger(input: string): AgentMetadata[]

  // 能力搜索
  findByCapability(capabilityId: string): AgentMetadata[]

  // 智能推荐
  recommend(intent: string): AgentMetadata | undefined
}
```

---

## 5. Rust 微服务架构

```
╔══════════════════════════════════════════════════════════════════════════════════════╗
║                              Rust 微服务架构                                          ║
╠══════════════════════════════════════════════════════════════════════════════════════╣
║                                                                                       ║
║                        ┌───────────────────────────────┐                             ║
║                        │      Zero Daemon :4402        │                             ║
║                        │      (进程编排器)              │                             ║
║                        │  ┌─────────┬─────────┬─────┐  │                             ║
║                        │  │ Spawn   │ Health  │ Log │  │                             ║
║                        │  │ 子进程  │  检查   │ 聚合│  │                             ║
║                        │  └─────────┴─────────┴─────┘  │                             ║
║                        └───────────────┬───────────────┘                             ║
║                                        │                                              ║
║          ┌─────────────────┬───────────┼───────────┬─────────────────┐               ║
║          │                 │           │           │                 │               ║
║          ▼                 ▼           ▼           ▼                 ▼               ║
║  ┌───────────────┐ ┌───────────────┐ ┌───────────────┐ ┌───────────────┐            ║
║  │Zero Gateway   │ │Zero Channels  │ │Zero Workflow  │ │Zero Trading   │            ║
║  │    :4430      │ │    :4431      │ │    :4432      │ │    :4434      │            ║
║  ├───────────────┤ ├───────────────┤ ├───────────────┤ ├───────────────┤            ║
║  │ ┌───────────┐ │ │ ┌───────────┐ │ │ ┌───────────┐ │ │ ┌───────────┐ │            ║
║  │ │ 认证模块  │ │ │ │ Telegram  │ │ │ │ Webhook   │ │ │ │ PO3策略   │ │            ║
║  │ │ ├─Pairing │ │ │ ├───────────┤ │ │ ├───────────┤ │ │ ├───────────┤ │            ║
║  │ │ └─JWT     │ │ │ │ Discord   │ │ │ │ Cron      │ │ │ │ SMT背离   │ │            ║
║  │ ├───────────┤ │ │ ├───────────┤ │ │ ├───────────┤ │ │ ├───────────┤ │            ║
║  │ │ 路由分发  │ │ │ │ Slack     │ │ │ │ Git集成   │ │ │ │ T+1适配   │ │            ║
║  │ ├───────────┤ │ │ ├───────────┤ │ │ ├───────────┤ │ │ ├───────────┤ │            ║
║  │ │ 配额管理  │ │ │ │ 飞书      │ │ │ │ RSS订阅   │ │ │ │ HITL确认  │ │            ║
║  │ ├───────────┤ │ │ ├───────────┤ │ │ ├───────────┤ │ │ └───────────┘ │            ║
║  │ │ RBAC权限  │ │ │ │ Email     │ │ │ │ Web爬虫   │ │ │               │            ║
║  │ ├───────────┤ │ │ ├───────────┤ │ │ └───────────┘ │ │               │            ║
║  │ │ 审计日志  │ │ │ │ iMessage  │ │ │               │ │               │            ║
║  │ └───────────┘ │ │ └───────────┘ │ │               │ │               │            ║
║  └───────────────┘ └───────────────┘ └───────────────┘ └───────────────┘            ║
║                                                                                       ║
║                        ┌───────────────────────────────┐                             ║
║                        │      Zero Common (共享库)      │                             ║
║                        ├───────────────────────────────┤                             ║
║                        │ config   │ logging  │ error   │                             ║
║                        │ security │ bus      │ audit   │                             ║
║                        │ validation                    │                             ║
║                        └───────────────────────────────┘                             ║
║                                                                                       ║
╚══════════════════════════════════════════════════════════════════════════════════════╝
```

### 5.1 服务职责

| 服务 | 端口 | 职责 |
|------|------|------|
| **Zero Daemon** | 4402 | 进程编排器，管理所有子服务 |
| **Zero Gateway** | 4430 | 认证、路由、配额、RBAC、审计 |
| **Zero Channels** | 4431 | IM 渠道适配 (Telegram/Discord/Slack/飞书) |
| **Zero Workflow** | 4432 | Webhook、Cron、Git 集成、RSS |
| **Zero Trading** | 4434 | PO3+SMT 交易策略 (开发中) |
| **Zero Browser** | 4433 | 浏览器自动化、API 重放 |

---

## 6. 记忆系统架构

```
┌─────────────────────────────────────────────────────────────────────────────────────┐
│                           双层记忆架构 (流 + 沉积)                                   │
├─────────────────────────────────────────────────────────────────────────────────────┤
│                                                                                      │
│   第一层: 每日笔记 (流/Stream)          第二层: 长期记忆 (沉积/Sediment)            │
│   ─────────────────────────────          ─────────────────────────────────          │
│                                                                                      │
│   memory/daily/2026-02-25.md             memory/MEMORY.md                           │
│   ┌─────────────────────────┐            ┌─────────────────────────┐               │
│   │ ## 10:30 - 任务A        │            │ ## 用户偏好              │               │
│   │ - 执行了什么            │    整合    │ - 代码风格: 函数式       │               │
│   │ - 结果如何              │  ────────► │                          │               │
│   │                         │    提炼    │ ## 关键决策              │               │
│   │ ## 14:00 - 任务B        │            │ - 2026-02-20: ...        │               │
│   │ - ...                   │            │                          │               │
│   └─────────────────────────┘            └─────────────────────────┘               │
│                                                                                      │
│   特点:                                  特点:                                      │
│   • 仅追加、不可修改                     • 可编辑、结构化                           │
│   • 按时间线记录                         • 代表当前真实状态                         │
│   • 类比: 河流 (flow)                    • 类比: 沉积岩                             │
│                                                                                      │
└─────────────────────────────────────────────────────────────────────────────────────┘
```

---

## 7. 依赖关系

### 7.1 TypeScript 包依赖

```
@codecoder-ai/ccode
  ├── @codecoder-ai/memory (workspace:*)
  ├── @codecoder-ai/util (workspace:*)
  ├── ai (Vercel AI SDK)
  ├── @modelcontextprotocol/sdk
  ├── solid-js + @opentui/solid
  └── [20+ AI provider SDKs]

@codecoder-ai/web
  ├── @codecoder-ai/util (workspace:*)
  ├── react + @tanstack/react-router
  ├── @radix-ui/* (UI 组件)
  └── zustand (状态管理)
```

### 7.2 Rust Crate 依赖

```
zero-cli
  ├── zero-common
  ├── zero-agent
  ├── zero-tools
  ├── zero-memory
  ├── zero-channels
  └── zero-gateway

zero-gateway / zero-channels / zero-workflow / zero-trading
  └── zero-common
```

---

## 8. 运维指南

### 8.1 服务启动

```bash
# 纯本地开发 (只需 ccode)
bun dev

# 完整服务部署
./ops.sh start all

# 单独启动服务
./ops.sh start redis
./ops.sh start api
./ops.sh start zero-daemon
```

### 8.2 健康检查

```bash
./ops.sh status   # 查看所有服务状态
./ops.sh health   # 健康检查
./ops.sh logs     # 查看日志
```

### 8.3 构建命令

```bash
# TypeScript
bun install
bun turbo typecheck

# Rust
./ops.sh build rust

# 独立可执行文件
cd packages/ccode && bun run build
```
