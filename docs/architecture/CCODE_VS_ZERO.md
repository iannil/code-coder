# packages/ccode 与 services/zero-* 的关系

> 生成时间: 2026-02-25

---

## 关系总览

```
╔══════════════════════════════════════════════════════════════════════════════════════╗
║                              关系总览: 双向 HTTP + 事件总线                            ║
╠══════════════════════════════════════════════════════════════════════════════════════╣
║                                                                                       ║
║                    packages/ccode                    services/zero-*                  ║
║                    (TypeScript/Bun)                  (Rust)                           ║
║                                                                                       ║
║                    ┌─────────────────┐               ┌─────────────────┐              ║
║                    │   AI 大脑       │               │   安全边界      │              ║
║                    │   Agent 引擎    │     HTTP      │   外部接入      │              ║
║                    │   业务逻辑      │ ◄──────────►  │   协议适配      │              ║
║                    │   记忆系统      │               │   工作流调度    │              ║
║                    └─────────────────┘               └─────────────────┘              ║
║                                                                                       ║
║   ┌────────────────────────────────────────────────────────────────────────────────┐ ║
║   │  核心关系: ccode 是 "智能中枢"，zero-* 是 "感知和执行器官"                      │ ║
║   │                                                                                │ ║
║   │  • ccode 负责: 理解意图 → 调用 AI → 生成响应 → 执行工具                        │ ║
║   │  • zero-* 负责: 接收外部消息 → 转发给 ccode → 返回响应给用户                   │ ║
║   └────────────────────────────────────────────────────────────────────────────────┘ ║
║                                                                                       ║
╚══════════════════════════════════════════════════════════════════════════════════════╝
```

---

## 一、通信方式

### 1.1 HTTP API 调用 (主要方式)

```
zero-channels ──HTTP──► ccode API Server (:4400)

// Rust 调用 TypeScript
// services/zero-channels/src/bridge.rs
┌────────────────────────────────────────────────────────────────────────┐
│  POST http://127.0.0.1:4400/api/chat                                   │
│  {                                                                      │
│    "message": "用户发送的消息",                                         │
│    "user_id": "telegram_12345",                                        │
│    "channel": "telegram",                                              │
│    "agent": "build"  // 可选指定 Agent                                 │
│  }                                                                      │
└────────────────────────────────────────────────────────────────────────┘

ccode scheduler ──HTTP──► zero-workflow (:4432)

// TypeScript 调用 Rust
// packages/ccode/src/api/server/handlers/scheduler.ts
┌────────────────────────────────────────────────────────────────────────┐
│  const WORKFLOW_SERVICE_URL = "http://127.0.0.1:4432"                  │
│  // 代理 cron 任务管理到 Rust 服务                                      │
└────────────────────────────────────────────────────────────────────────┘
```

### 1.2 事件总线 (Event Bus)

```
┌─────────────────────────────────────────────────────────────────────────┐
│                          Redis Pub/Sub                                   │
│                                                                          │
│   Topic                   方向           用途                           │
│   ─────────────────────────────────────────────────────────────────     │
│   agent.request           Rust → TS      请求执行 Agent                 │
│   agent.response          TS → Rust      Agent 执行结果                 │
│   channel.message         Rust → TS      收到的渠道消息                 │
│   channel.outgoing        TS → Rust      要发送的渠道消息               │
│   session.start/end       TS → Rust      会话生命周期                   │
│   memory.update           TS → Rust      记忆更新通知                   │
│                                                                          │
└─────────────────────────────────────────────────────────────────────────┘
```

### 1.3 工具调用 (Rust 作为 ccode 的工具)

```rust
// services/zero-tools/src/codecoder.rs
// Rust 可以作为 Agent 的工具反过来调用 ccode

pub struct CodeCoderTool {
    endpoint: String,  // "http://127.0.0.1:4400"
}

// 创建任务并流式获取响应
async fn execute(&self, agent: &str, prompt: &str) -> ToolResult
```

---

## 二、职责划分

```
┌─────────────────────────────────────────────────────────────────────────────────────┐
│                              职责划分对比                                            │
├─────────────────────────────────────────────────────────────────────────────────────┤
│                                                                                      │
│   packages/ccode (TypeScript/Bun)             services/zero-* (Rust)                │
│   ══════════════════════════════════          ══════════════════════════════════    │
│                                                                                      │
│   ┌────────────────────────────────┐          ┌────────────────────────────────┐   │
│   │ 核心职责: AI 智能处理          │          │ 核心职责: 外部世界接口         │   │
│   ├────────────────────────────────┤          ├────────────────────────────────┤   │
│   │                                │          │                                │   │
│   │ ✓ Agent 引擎 (23个Agent)      │          │ ✓ 渠道适配 (Telegram/Discord)  │   │
│   │   • build, plan, code-reviewer │          │   • 消息格式转换               │   │
│   │   • security-reviewer          │          │   • 长轮询/WebSocket           │   │
│   │   • macro, trader, decision    │          │   • 富文本渲染                 │   │
│   │                                │          │                                │   │
│   │ ✓ AI Provider 调用            │          │ ✓ 安全网关                     │   │
│   │   • Anthropic, OpenAI, Google  │          │   • 认证 (Pairing + JWT)       │   │
│   │   • 统一 Vercel AI SDK 接口    │          │   • RBAC 权限控制              │   │
│   │                                │          │   • 配额管理                   │   │
│   │ ✓ 工具执行                    │          │   • 审计日志                   │   │
│   │   • 文件读写、Bash 执行        │          │                                │   │
│   │   • Git 操作、LSP 集成         │          │ ✓ 工作流调度                   │   │
│   │                                │          │   • Cron 定时任务              │   │
│   │ ✓ 记忆系统                    │          │   • Webhook 处理               │   │
│   │   • Markdown 双层记忆          │          │   • Git 事件监听               │   │
│   │   • 上下文管理                 │          │                                │   │
│   │                                │          │ ✓ 交易系统 (开发中)            │   │
│   │ ✓ MCP Server                  │          │   • PO3 + SMT 策略             │   │
│   │   • Model Context Protocol     │          │   • 信号生成                   │   │
│   │                                │          │                                │   │
│   └────────────────────────────────┘          └────────────────────────────────┘   │
│                                                                                      │
│   ┌────────────────────────────────────────────────────────────────────────────┐   │
│   │  设计原则:                                                                   │   │
│   │                                                                              │   │
│   │  "TypeScript 管思考，Rust 管边界"                                           │   │
│   │                                                                              │   │
│   │  • AI 调用、Agent 逻辑需要快速迭代 → TypeScript 灵活性                      │   │
│   │  • 外部输入、安全敏感操作 → Rust 内存安全 + 类型严格                        │   │
│   └────────────────────────────────────────────────────────────────────────────┘   │
│                                                                                      │
└─────────────────────────────────────────────────────────────────────────────────────┘
```

---

## 三、典型调用流程

### 3.1 Telegram 用户发消息给 Bot

```
Telegram
   │
   │  1. Webhook POST
   ▼
┌─────────────────┐
│ zero-gateway    │  2. 验证签名、检查配额
│    :4430        │
└────────┬────────┘
         │
         │  3. 转发到 channels
         ▼
┌─────────────────┐
│ zero-channels   │  4. 解析消息格式、提取文本
│    :4431        │
└────────┬────────┘
         │
         │  5. HTTP POST /api/chat
         ▼
┌─────────────────┐
│ ccode API       │  6. 选择 Agent、调用 AI、生成响应
│    :4400        │
└────────┬────────┘
         │
         │  7. JSON 响应 { message: "..." }
         ▼
┌─────────────────┐
│ zero-channels   │  8. 转换为 Telegram MarkdownV2 格式
│    :4431        │
└────────┬────────┘
         │
         │  9. sendMessage API
         ▼
Telegram
```

### 3.2 ccode 调度定时任务

```
用户在 TUI 中: "每天早上9点运行 macro agent 分析经济数据"
   │
   │  1. 创建任务请求
   ▼
┌─────────────────┐
│ ccode API       │  2. 解析 cron 表达式、验证 agent
│    :4400        │
└────────┬────────┘
         │
         │  3. POST /api/v1/tasks (代理到 Rust)
         ▼
┌─────────────────┐
│ zero-workflow   │  4. 存储任务到 SQLite、注册到调度器
│    :4432        │
└────────┬────────┘
         │
         │  ... 每天 9:00 触发 ...
         │
         │  5. 调度器触发任务
         ▼
┌─────────────────┐
│ zero-workflow   │  6. HTTP POST /api/task (调用 ccode 执行)
│    :4432        │
└────────┬────────┘
         │
         ▼
┌─────────────────┐
│ ccode API       │  7. 执行 macro Agent、生成分析报告
│    :4400        │
└────────┬────────┘
         │
         │  8. 通过 Event Bus 发送 channel.outgoing
         ▼
┌─────────────────┐
│ zero-channels   │  9. 推送到 Telegram/Discord
│    :4431        │
└─────────────────┘
```

---

## 四、依赖方向

```
┌─────────────────────────────────────────────────────────────────────────────────────┐
│                              依赖方向分析                                            │
├─────────────────────────────────────────────────────────────────────────────────────┤
│                                                                                      │
│                         ┌─────────────────────────────────┐                         │
│                         │         packages/ccode          │                         │
│                         │       (AI 智能核心)              │                         │
│                         │                                 │                         │
│                         │  • 不直接依赖任何 zero-* 服务   │                         │
│                         │  • 通过 HTTP API 被调用         │                         │
│                         │  • 可以独立运行 (TUI/CLI)       │                         │
│                         └───────────────┬─────────────────┘                         │
│                                         │                                            │
│                           被调用 (HTTP) │ 调用 (HTTP)                                │
│                                         │                                            │
│         ┌───────────────────────────────┼───────────────────────────────┐           │
│         │                               │                               │           │
│         ▼                               ▼                               ▼           │
│   ┌───────────────┐             ┌───────────────┐             ┌───────────────┐    │
│   │zero-channels  │             │zero-workflow  │             │zero-gateway   │    │
│   │  (渠道层)     │             │  (调度层)     │             │  (网关层)     │    │
│   │               │             │               │             │               │    │
│   │ 调用 ccode    │             │ 调用 ccode    │             │ 路由到其他    │    │
│   │ 处理消息      │             │ 执行任务      │             │ 服务          │    │
│   └───────┬───────┘             └───────┬───────┘             └───────┬───────┘    │
│           │                             │                             │            │
│           └─────────────────────────────┼─────────────────────────────┘            │
│                                         │                                           │
│                                         ▼                                           │
│                         ┌─────────────────────────────────┐                         │
│                         │        zero-common              │                         │
│                         │       (共享基础库)               │                         │
│                         │                                 │                         │
│                         │  • config (统一配置)            │                         │
│                         │  • logging (结构化日志)         │                         │
│                         │  • bus (事件总线)               │                         │
│                         │  • security (安全模块)          │                         │
│                         └─────────────────────────────────┘                         │
│                                                                                      │
│   ┌────────────────────────────────────────────────────────────────────────────┐   │
│   │  关键观察:                                                                   │   │
│   │                                                                              │   │
│   │  1. ccode 是被动的 - 它暴露 API，等待被调用                                 │   │
│   │  2. zero-* 是主动的 - 它们监听外部事件，然后调用 ccode                      │   │
│   │  3. 单向依赖 - zero-* 依赖 ccode 的 API，ccode 不依赖 zero-*               │   │
│   │  4. 松耦合 - 可以只运行 ccode (本地 CLI)，也可以加上 zero-* (远程服务)      │   │
│   └────────────────────────────────────────────────────────────────────────────┘   │
│                                                                                      │
└─────────────────────────────────────────────────────────────────────────────────────┘
```

---

## 五、部署模式

### 5.1 模式 A: 纯本地开发 (只需 ccode)

```
┌─────────────────────────────────────────────────────────────────────────┐
│                         本地机器                                         │
│                                                                          │
│   终端 ──► bun dev ──► ccode (TUI)                                      │
│                           │                                              │
│                           ├── Agent 引擎                                 │
│                           ├── AI Provider 调用                           │
│                           ├── 文件系统工具                               │
│                           └── 记忆系统                                   │
│                                                                          │
│   不需要: Redis, zero-gateway, zero-channels, zero-workflow              │
│                                                                          │
└─────────────────────────────────────────────────────────────────────────┘
```

### 5.2 模式 B: 完整服务部署 (ccode + zero-*)

```
┌─────────────────────────────────────────────────────────────────────────┐
│                         服务器                                           │
│                                                                          │
│   ./ops.sh start all                                                    │
│                                                                          │
│   ┌───────────────┐                                                     │
│   │ Zero Daemon   │──spawn──┬── zero-gateway :4430                      │
│   │    :4402      │         ├── zero-channels :4431                     │
│   └───────────────┘         ├── zero-workflow :4432                     │
│                             └── zero-trading :4434 (可选)               │
│                                                                          │
│   ┌───────────────┐   ┌───────────────┐   ┌───────────────┐            │
│   │ ccode API     │   │    Redis      │   │   Whisper     │            │
│   │    :4400      │   │    :6379      │   │    :4403      │            │
│   └───────────────┘   └───────────────┘   └───────────────┘            │
│                                                                          │
└─────────────────────────────────────────────────────────────────────────┘
       ▲
       │ Telegram/Discord/Slack/Webhook
       │
┌──────┴──────┐
│  外部世界   │
└─────────────┘
```

---

## 六、底层原则：确定性 vs 不确定性

### 6.1 核心洞察

```
┌─────────────────────────────────────────────────────────────────────────────────────┐
│                         确定性 vs 不确定性 划分原则                                   │
├─────────────────────────────────────────────────────────────────────────────────────┤
│                                                                                      │
│   高确定性任务 → zero-* (Rust)        低确定性任务 → ccode (TypeScript/LLM)         │
│   保证效果和效率                       保证正确的反应和应对                          │
│                                                                                      │
│   ◄────────────────────────── 确定性谱系 ──────────────────────────►                │
│                                                                                      │
│   ┌──────────────────────────┐              ┌──────────────────────────┐            │
│   │     zero-* (Rust)        │              │    ccode (TS/LLM)        │            │
│   ├──────────────────────────┤              ├──────────────────────────┤            │
│   │ • 协议解析               │              │ • 意图理解               │            │
│   │ • 加密/签名              │              │ • 上下文推理             │            │
│   │ • 速率限制               │              │ • 代码生成               │            │
│   │ • 定时调度               │              │ • 决策建议               │            │
│   │ • 消息路由               │              │ • 自然语言处理           │            │
│   │ • 权限校验               │              │ • 多轮对话               │            │
│   └──────────────────────────┘              └──────────────────────────┘            │
│                                                                                      │
│   特点：                                     特点：                                  │
│   • 输入→输出 可预测                        • 输入→输出 不可预测                     │
│   • 规则明确，无歧义                        • 需要"理解"和"判断"                     │
│   • 错误可枚举                              • 错误难以预料                            │
│   • 性能敏感                                • 质量敏感                                │
│                                                                                      │
│   保障手段：                                保障手段：                               │
│   • 类型系统                                • 大模型能力                              │
│   • 编译检查                                • Prompt 工程                             │
│   • 单元测试                                • Agent 协作                              │
│   • 形式化验证                              • 人类反馈                                │
│                                                                                      │
└─────────────────────────────────────────────────────────────────────────────────────┘
```

### 6.2 设计决策指南

| 任务类型 | 最佳工具 | 原因 |
|---------|---------|------|
| 解析 Telegram 消息格式 | Rust (zero-channels) | 格式固定，需要高性能 |
| 理解用户想要什么 | LLM (ccode) | 自然语言模糊，需要推理 |
| JWT 签名验证 | Rust (zero-gateway) | 算法确定，安全敏感 |
| 生成代码审查建议 | LLM (ccode) | 需要代码理解能力 |
| Webhook 签名校验 | Rust (zero-gateway) | 规则固定，安全敏感 |
| 选择合适的 Agent | LLM (ccode) | 需要语义理解 |
| Cron 表达式解析 | Rust (zero-workflow) | 语法规范明确 |
| 分析宏观经济数据 | LLM (ccode/macro) | 需要领域知识和推理 |

### 6.3 与祝融说哲学的呼应

```
┌─────────────────────────────────────────────────────────────────────────────────────┐
│                                                                                      │
│   确定性部分 (zero-*)                 不确定性部分 (ccode)                           │
│         ↓                                    ↓                                       │
│   已坍缩的可能性                       可用余量 (Available Margin)                   │
│   规则、协议、约束                     创造性、适应性、智能                          │
│                                                                                      │
│   ┌────────────────────────────────────────────────────────────────────────────┐   │
│   │  核心洞察:                                                                   │   │
│   │                                                                              │   │
│   │  真正的智慧在于管理可能性的边界，而非追求确定性的最优                        │   │
│   │                                                                              │   │
│   │  • zero-* 负责"已知的已知" — 用 Rust 的类型系统和性能保证效果               │   │
│   │  • ccode 负责"已知的未知" — 用大模型的推理能力应对不确定性                  │   │
│   │                                                                              │   │
│   │  这种划分让每种技术都用在最擅长的地方                                        │   │
│   └────────────────────────────────────────────────────────────────────────────┘   │
│                                                                                      │
└─────────────────────────────────────────────────────────────────────────────────────┘
```

### 6.4 实际调用流程示例

当用户通过 Telegram 发送 `"帮我审查这段代码"`:

```
1. zero-channels: 确定性地解析 Telegram API 消息格式    ← 协议固定
2. zero-gateway:  确定性地验证用户身份和配额           ← 规则明确
3. ccode API:     不确定性地理解"审查"的含义           ← 需要推理
4. code-reviewer: 不确定性地生成有价值的审查意见       ← 需要智能
5. zero-channels: 确定性地格式化并发送回 Telegram      ← 格式固定
```

---

## 七、总结

```
┌─────────────────────────────────────────────────────────────────────────────────────┐
│                              关系总结                                                │
├─────────────────────────────────────────────────────────────────────────────────────┤
│                                                                                      │
│   packages/ccode                       services/zero-*                              │
│   ─────────────                        ───────────────                              │
│                                                                                      │
│   • 语言: TypeScript/Bun               • 语言: Rust                                 │
│   • 角色: AI 智能核心                  • 角色: 外部世界接口                         │
│   • 定位: 被调用方                     • 定位: 调用方                               │
│   • 特点: 快速迭代、灵活              • 特点: 安全、高性能                         │
│                                                                                      │
│   通信方式:                                                                         │
│   • HTTP API (主要)                                                                 │
│   • Redis Event Bus (事件驱动)                                                      │
│   • SSE 流式响应 (长任务)                                                           │
│                                                                                      │
│   比喻:                                                                             │
│   • ccode = 大脑 (思考、决策)                                                       │
│   • zero-* = 感官和肢体 (感知外界、执行动作)                                        │
│                                                                                      │
└─────────────────────────────────────────────────────────────────────────────────────┘
```

### 设计考量

1. **可独立运行** - ccode 可以纯本地运行（TUI 模式），不需要任何 Rust 服务。这对于开发者日常使用非常重要，降低了使用门槛。

2. **安全边界清晰** - 所有外部输入（Telegram 消息、Webhook 请求）必须经过 Rust 服务验证后才能到达 ccode。Rust 的内存安全特性在这里充当了"防火墙"。

3. **扩展性设计** - 如果需要新增一个渠道（如 WhatsApp），只需要在 zero-channels 中添加适配器，ccode 的代码完全不需要改动。这是典型的"开闭原则"应用。
